#  Main body of the LANCELOT B installation makefile under GALAHAD

#  N. Gould and Ph. L. Toint.
#  This version: 2022-12-19

SHELL = /bin/$(BINSHELL)

ifeq "$(PRECIS)" "single"
 DPREC = -DGALAHAD_SINGLE
else
 DPREC = -DGALAHAD_DOUBLE
endif

ifeq "$(LINEARSOLVER)" "ma57"
 DLINEARSOLVER = -DLANCELOT_USE_MA57
else
 DLINEARSOLVER = -DLANCELOT_USE_SILS
endif

#  compiler flags

FFLAGS    = $(BASIC) $(OPTIMIZATION) $(DEBUG) $(MODULES) $(F90) $(USUAL) \
              $(DPREC) $(DLINEARSOLVER) -I $(GALAHAD)/include
FFLAGSS   = $(BASIC) $(OPTIMIZATION) $(DEBUG) $(MODULES) $(F90) $(SPECIAL) \
              $(DPREC) $(DLINEARSOLVER) -I $(GALAHAD)/include
FFLAGSN   = $(BASIC) $(NOOPTIMIZATION) $(DEBUG) $(MODULES) $(F90) \
              $(DPREC) $(DLINEARSOLVER) -I $(GALAHAD)/include
FFLAGS77  = $(BASIC) $(OPTIMIZATION) $(DEBUG) $(MODULES) $(F77) $(USUAL) \
              $(DPREC) $(DLINEARSOLVER) -I $(GALAHAD)/include
FFLAGS77S = $(BASIC) $(OPTIMIZATION) $(DEBUG) $(MODULES) $(F77) $(SPECIAL) \
              $(DPREC) $(DLINEARSOLVER) -I $(GALAHAD)/include
RUNFFLAGS =          $(OPTIMIZATION) $(DEBUG) $(MODULES)

#  names of random libraries

LG  = $(OBJ)/libgalahad.a
LGS = $(OBJS)/libgalahad.a
LGD = $(OBJD)/libgalahad.a

BLG  = $(OBJ)/libgalahad_blas.a
BLGS = $(OBJS)/libgalahad_blas.a
BLGD = $(OBJD)/libgalahad_blas.a

CULG  = $(OBJ)/libgalahad_cutest.a
CULGS = $(OBJS)/libgalahad_cutest.a
CULGD = $(OBJD)/libgalahad_cutest.a

HLG  = $(OBJ)/libgalahad_hsl.a
HLGS = $(OBJS)/libgalahad_hsl.a
HLGD = $(OBJD)/libgalahad_hsl.a

MLG  = $(OBJ)/libgalahad_metis4.a
MLGS = $(OBJS)/libgalahad_metis4.a
MLGD = $(OBJD)/libgalahad_metis4.a

#  Libraries used

LIBS = -lgalahad $(HSL) $(METIS4) $(LAPACK) $(BLAS)

#  Archive manipulation strings

ARR = $(AR) $(ARREPFLAGS) $(LG)

BARR = $(AR) $(ARREPFLAGS) $(BLG)
BRMARFILE = $(GALAHAD)/bin/rmarfile $(AR) $(GREP) $(BLG)

CUARR = $(AR) $(ARREPFLAGS) $(CULG)
CURMARFILE = $(GALAHAD)/bin/rmarfile $(AR) $(GREP) $(CULG)

HARR = $(AR) $(ARREPFLAGS) $(HLG)
HRMARFILE = $(GALAHAD)/bin/rmarfile $(AR) $(GREP) $(HLG)

RMARFILE = $(GALAHAD)/bin/rmarfile $(AR) $(GREP) $(LG)
RMOBFILE = $(GALAHAD)/bin/rmobfile $(RM) $(OBJ)

MARR = $(AR) $(ARREPFLAGS) $(MLG)
MRMARFILE = $(GALAHAD)/bin/rmarfile $(AR) $(GREP) $MHLG)

#  compilation agenda

OBJECTSBASICS = extend basics scu $(LGS)(bndsl_single.o)  \
         $(LGS)(others_single.o) icfs ma61 linearsolver ma57 sils ad02 \
         $(LGS)(cauchy_single.o) $(LGS)(cg_single.o) $(LGS)(hslint_single.o) \
         $(LGS)(asmbl_single.o) $(LGS)(hsprd_single.o) $(LGS)(initw_single.o) \
         $(LGS)(mdchl_single.o) $(LGS)(precn_single.o) \
         $(LGS)(frntl_single.o) $(LGS)(strutr_single.o) \
         $(LGS)(lancelot_types_single.o)
OBJECTSS = $(OBJECTSBASICS) $(LGS)(lancelot_single.o) \
         $(LGS)(lancelot_simple_single.o)
OBJECTSSTEERINGS = $(OBJECTSBASICS) $(LGS)(lancelot_steering_single.o)
OBJECTSFILTRANES = extend $(LGS)(bndsl_single.o)
OBJECTSPSLSS = $(OBJECTSFILTRANES) ma61 $(LGS)(hslint_single.o) \
         $(LGS)(mdchl_single.o)
USEOBJECTSS = $(OBJECTSS) $(LGS)(scaln_single.o) $(LGS)(drchg_single.o) \
         $(LGS)(drche_single.o) rand copyright \
         $(CULGS)(uselancelot_single.o)
USEOBJECTSSTEERINGS = $(OBJECTSSTEERINGS) $(LGS)(scaln_single.o) \
          $(LGS)(drchg_single.o) $(LGS)(drche_single.o) rand \
          copyright $(CULGS)(uselancelot_steering_single.o)

OBJECTSBASICD = extend basics scu $(LGD)(bndsl_double.o) \
          $(LGD)(others_double.o) icfs ma61 linearsolver ma57 sils ad02 \
          $(LGD)(cauchy_double.o) $(LGD)(cg_double.o) $(LGD)(hslint_double.o) \
          $(LGD)(asmbl_double.o) $(LGD)(hsprd_double.o) $(LGD)(initw_double.o) \
          $(LGD)(mdchl_double.o)  $(LGD)(precn_double.o) \
          $(LGD)(frntl_double.o)  $(LGD)(strutr_double.o) \
          $(LGD)(lancelot_types_double.o)
OBJECTSD = $(OBJECTSBASICD) $(LGD)(lancelot_double.o) \
           $(LGD)(lancelot_simple_double.o)
OBJECTSSTEERINGD = $(OBJECTSBASICD) $(LGD)(lancelot_steering_double.o)
OBJECTSFILTRANED = extend $(LGD)(bndsl_double.o)
OBJECTSPSLSD = $(OBJECTSFILTRANED) ma61 $(LGD)(hslint_double.o) \
           $(LGD)(mdchl_double.o)
USEOBJECTSD = $(OBJECTSD) $(LGD)(scaln_double.o) $(LGD)(drchg_double.o) \
           $(LGD)(drche_double.o) rand copyright \
           $(CULGD)(uselancelot_double.o)
USEOBJECTSSTEERINGD = $(OBJECTSSTEERINGD) $(LGD)(scaln_double.o) \
           $(LGD)(drchg_double.o) $(LGD)(drche_double.o) rand \
           copyright $(CULGD)(uselancelot_steering_double.o)

SUCC = precision version) compiled successfully
SUCC_SIF = precision version) for SIF compiled successfully

#  valgrind options if needed

VALGRIND = -v --tool=memcheck --leak-check=yes --show-reachable=yes \
#VALGRIND = --tool=memcheck --leak-check=full --show-reachable=yes \
--track-origins=yes

#  main compilations and runs

all: lancelotb_sif

lancelotb_sif: lancelotb_sif_$(PRECIS)
	@printf ' %-21s\n' "GALAHAD: LANCELOT B ($(PRECIS) $(SUCC_SIF)"
lancelotb_sif_single: $(USEOBJECTSS) $(OBJS)/runlancelot_sif_single.o
	$(RANLIB) $(LGS)
lancelotb_sif_double: $(USEOBJECTSD) $(OBJD)/runlancelot_sif_double.o
	$(RANLIB) $(LGD)

lancelotb_silent: lancelotb_silent_$(PRECIS)
lancelotb_silent_single: $(OBJECTSS)
lancelotb_silent_double: $(OBJECTSD)

lancelotb: lancelotb_$(PRECIS)
	@printf ' %-21s\n' "GALAHAD: LANCELOT B ($(PRECIS) $(SUCC)"
lancelotb_single: $(OBJECTSS)
	$(RANLIB) $(LGS)
lancelotb_double: $(OBJECTSD)
	$(RANLIB) $(LGD)

use_lancelotb_silent: use_lancelotb_$(PRECIS)
use_lancelotb: use_lancelotb_$(PRECIS)
	@printf ' %-21s\n' "GALAHAD: LANCELOT B ($(PRECIS) $(SUCC)"
use_lancelotb_single: $(USEOBJECTSS)
	$(RANLIB) $(LGS)
use_lancelotb_double: $(USEOBJECTSD)
	$(RANLIB) $(LGD)

all_steering: lancelotb_steering_sif

lancelotb_steering_sif: lancelotb_steering_sif_$(PRECIS)
	@printf ' %-21s\n' "GALAHAD: LANCELOT B STEERING ($(PRECIS) $(SUCC_SIF)"
lancelotb_steering_sif_single: $(USEOBJECTSSTEERINGS) \
           $(OBJS)/runlancelot_steering_sif_single.o
	$(RANLIB) $(LGS)
lancelotb_steering_sif_double: $(USEOBJECTSSTEERINGD) \
           $(OBJD)/runlancelot_steering_sif_double.o
	$(RANLIB) $(LGD)

lancelotb_steering_silent: lancelotb_steering_silent_$(PRECIS)
lancelotb_steering_silent_single: $(OBJECTSS)
lancelotb_steering_silent_double: $(OBJECTSD)

lancelotb_steering: lancelotb_steering_$(PRECIS)
	@printf ' %-21s\n' "GALAHAD: LANCELOT B ($(PRECIS) $(SUCC)"
lancelotb_steering_single: $(OBJECTSS)
	$(RANLIB) $(LGS)
lancelotb_steering_double: $(OBJECTSD)
	$(RANLIB) $(LGD)

use_lancelotb_steering_silent: use_lancelotb_steering_$(PRECIS)
use_lancelotb_steering: use_lancelotb_steering_$(PRECIS)
	@printf ' %-21s\n' "GALAHAD: LANCELOT B ($(PRECIS) $(SUCC)"
use_lancelotb_steering_single: $(USEOBJECTSS)
	$(RANLIB) $(LGS)
use_lancelotb_steering_double: $(USEOBJECTSD)
	$(RANLIB) $(LGD)

lancelotb_psls_silent: lancelotb_silent_psls_$(PRECIS)
lancelotb_silent_psls_single: $(OBJECTSPSLSS)
lancelotb_silent_psls_double: $(OBJECTSPSLSD)

lancelotb_psls: lancelotb_psls_$(PRECIS)
	@printf ' %-21s\n' "GALAHAD: LANCELOT B ($(PRECIS) $(SUCC)"
lancelotb_psls_single: $(OBJECTSPSLSS)
	$(RANLIB) $(LGS)
lancelotb_psls_double: $(OBJECTSPSLSD)
	$(RANLIB) $(LGD)

lancelotb_filtrane_silent: lancelotb_silent_filtrane_$(PRECIS)
lancelotb_silent_filtrane_single: $(OBJECTSFILTRANES)
lancelotb_silent_filtrane_double: $(OBJECTSFILTRANED)

lancelotb_filtrane: lancelotb_filtrane_$(PRECIS)
	@printf ' %-21s\n' "GALAHAD: LANCELOT B ($(PRECIS) $(SUCC)"
lancelotb_filtrane_single: $(OBJECTSFILTRANES)
	$(RANLIB) $(LGS)
lancelotb_filtrane_double: $(OBJECTSFILTRANED)
	$(RANLIB) $(LGD)

tests: test test_cutest

tests_all: lancelotss lancelotst lancelotds lancelotdt
tests_steering: lancelot_steeringss lancelot_steeringst \
                lancelot_steeringds lancelot_steeringdt
tests_simple: lancelot_simpless lancelot_simplest \
              lancelot_simpleds lancelot_simpledt

test: test_$(PRECIS)
test_single: lancelotst
	echo " Tests for LANCELOT B complete"
test_double: lancelotdt
	echo " Tests for LANCELOT B complete"

test_sif: test_cutest
test_cutest: test_cutest_$(PRECIS)
test_cutest_single: $(USEOBJECTSS) $(OBJS)/runlancelot_sif_single.o
	echo ""
	echo " Testing SIF interface to LANCELOT B"
	cd $(GALAHAD)/examples ; sdgal $(VERSION) lancelot -s ALLINITC
	echo ""
	echo " Tests for LANCELOT B complete"
test_cutest_double: $(USEOBJECTSD) $(OBJD)/runlancelot_sif_double.o
	echo ""
	echo " Testing SIF interface to LANCELOT B"
	cd $(GALAHAD)/examples ; sdgal $(VERSION) lancelot ALLINITC
	echo ""
	echo " Tests for LANCELOT B complete"

test_full: test_full_$(PRECIS)
test_full_single: lancelotst
	echo ""
	echo " Tests for LANCELOT B complete"
test_full_double: lancelotdt
	echo ""
	echo " Tests for LANCELOT B complete"

test_spec: test_spec_$(PRECIS)
test_spec_single: lancelotss
	echo ""
	echo " Tests for LANCELOT B complete"
test_spec_double: lancelotds
	echo ""
	echo " Tests for LANCELOT B complete"

lancelotss: $(OBJECTSS) $(OBJS)/lancelots.o
	$(FORTRAN) $(RUNFFLAGS) $(SPECIAL) -o run_lancelot $(OBJS)/lancelots.o \
            -L$(OBJS) $(LIBS)
	- ./run_lancelot > lancelotss.output 2>&1
	cat lancelotss.output
	rm ./run_lancelot

lancelotds: $(OBJECTSD) $(OBJD)/lancelots.o
	$(FORTRAN) $(RUNFFLAGS) $(SPECIAL) -o run_lancelot $(OBJD)/lancelots.o \
            -L$(OBJD) $(LIBS)
	- ./run_lancelot > lancelotds.output 2>&1
	cat lancelotds.output
	rm ./run_lancelot

lancelotst: $(OBJECTSS) $(OBJS)/lancelott_single.o
	echo ""
	echo " Exhaustive test of subroutine interface to LANCELOT B"
	$(FORTRAN) $(RUNFFLAGS) $(SPECIAL) -o run_lancelot \
           $(OBJS)/lancelott_single.o -L$(OBJS) $(LIBS)
	- ./run_lancelot > lancelotst.output 2>&1
	cat lancelotst.output
	rm ./run_lancelot

lancelotdt: $(OBJECTSD) $(OBJD)/lancelott_double.o
	echo ""
	echo " Exhaustive test of subroutine interface to LANCELOT B"
	$(FORTRAN) $(RUNFFLAGS) $(SPECIAL) -o run_lancelot \
           $(OBJD)/lancelott_double.o -L$(OBJD) $(LIBS)
	- ./run_lancelot > lancelotdt.output 2>&1
	cat lancelotdt.output
	rm ./run_lancelot

lancelotdt_valgrind: $(OBJECTSD) $(OBJD)/lancelott_double.o
	echo ""
	echo " Exhaustive test of subroutine interface to LANCELOT B"
	$(FORTRAN) $(RUNFFLAGS) $(SPECIAL) -o run_lancelot \
            $(OBJD)/lancelott_double.o -L$(OBJD) $(LIBS)
	- valgrind $(VALGRIND) ./run_lancelot > \
           lancelotdt_valgrind.output 2>&1
	cat lancelotdt_valgrind.output
	rm ./run_lancelot

lancelot_steeringss: $(OBJECTSSTEERINGS) $(OBJS)/lancelot_steerings.o
	$(FORTRAN) $(RUNFFLAGS) $(SPECIAL) -o run_lancelot_steering \
            $(OBJS)/lancelot_steerings.o -L$(OBJS) $(LIBS)
	- ./run_lancelot_steering > lancelot_steeringss.output 2>&1
	cat lancelot_steeringss.output
	rm ./run_lancelot_steering

lancelot_steeringds: $(OBJECTSSTEERINGD) $(OBJD)/lancelot_steerings.o
	$(FORTRAN) $(RUNFFLAGS) $(SPECIAL) -o run_lancelot_steering \
          $(OBJD)/lancelot_steerings.o -L$(OBJD) $(LIBS)
	- ./run_lancelot_steering > lancelot_steeringds.output 2>&1
	cat lancelot_steeringds.output
	rm ./run_lancelot_steering

lancelot_steeringst: $(OBJECTSSTEERINGS) $(OBJS)/lancelot_steeringt_single.o
	echo ""
	echo " Exhaustive test of subroutine interface to LANCELOT B"
	$(FORTRAN) $(RUNFFLAGS) $(SPECIAL) -o run_lancelot_steering \
          $(OBJS)/lancelot_steeringt_single.o -L$(OBJS) $(LIBS)
	- ./run_lancelot_steering > lancelot_steeringst.output 2>&1
	cat lancelot_steeringst.output
	rm ./run_lancelot_steering

lancelot_steeringdt: $(OBJECTSSTEERINGD) $(OBJD)/lancelot_steeringt_double.o
	echo ""
	echo " Exhaustive test of subroutine interface to LANCELOT B"
	$(FORTRAN) $(RUNFFLAGS) $(SPECIAL) -o run_lancelot_steering \
          $(OBJD)/lancelot_steeringt_double.o -L$(OBJD) $(LIBS)
	- ./run_lancelot_steering > lancelot_steeringdt.output 2>&1
	cat lancelot_steeringdt.output
	rm ./run_lancelot_steering

lancelot_simpless: $(OBJECTSS) $(OBJS)/lancelot_simples.o
	$(FORTRAN) $(RUNFFLAGS) $(SPECIAL) -o run_lancelot_simple \
           $(OBJS)/lancelot_simples.o -L$(OBJS) $(LIBS)
	- ./run_lancelot_simple > lancelot_simpless.output 2>&1
	cat lancelot_simpless.output
	rm ./run_lancelot_simple

lancelot_simpleds: $(OBJECTSD) $(OBJD)/lancelot_simples.o
	$(FORTRAN) $(RUNFFLAGS) $(SPECIAL) -o run_lancelot_simple \
           $(OBJD)/lancelot_simples.o -L$(OBJD) $(LIBS)
	- ./run_lancelot_simple > lancelot_simpleds.output 2>&1
	cat lancelot_simpleds.output
	rm ./run_lancelot_simple

lancelot_simplest: $(OBJECTSS) $(OBJS)/lancelot_simplet_single.o
	echo ""
	echo " Exhaustive test of subroutine interface to LANCELOT B"
	$(FORTRAN) $(RUNFFLAGS) $(SPECIAL) -o run_lancelot_simple \
           $(OBJS)/lancelot_simplet_single.o -L$(OBJS) $(LIBS)
	- ./run_lancelot_simple > lancelot_simplest.output 2>&1
	cat lancelot_simplest.output
	rm ./run_lancelot_simple

lancelot_simpledt: $(OBJECTSD) $(OBJD)/lancelot_simplet_double.o
	echo ""
	echo " Exhaustive test of subroutine interface to LANCELOT B"
	$(FORTRAN) $(RUNFFLAGS) $(SPECIAL) -o run_lancelot_simple \
            $(OBJD)/lancelot_simplet_double.o -L$(OBJD) $(LIBS)
	- ./run_lancelot_simple > lancelot_simpledt.output 2>&1
	cat lancelot_simpledt.output
	rm ./run_lancelot_simple

#  basic packages

extend:
	( cd ../extend ; $(MAKE) -f $(GALAHAD)/makefiles/$(VERSION) \
            extend_silent PRECIS=$(PRECIS) PWD=$(PWD)/../extend )
basics:
	( cd ../general ; $(MAKE) -f $(GALAHAD)/makefiles/$(VERSION) \
            basic_silent PRECIS=$(PRECIS) PWD=$(PWD)/../general )
linearsolver:
	( cd ../general ; $(MAKE) -f $(GALAHAD)/makefiles/$(VERSION) \
            linearsolver_silent PRECIS=$(PRECIS) PWD=$(PWD)/../general )
sils:
	( cd ../sils ; $(MAKE) -f $(GALAHAD)/makefiles/$(VERSION) \
            sils_silent PRECIS=$(PRECIS) PWD=$(PWD)/../sils )
scu:
	( cd ../scu ; $(MAKE) -f $(GALAHAD)/makefiles/$(VERSION) \
            scu_silent  PRECIS=$(PRECIS) PWD=$(GALAHAD)/src/scu )
rand:
	( cd ../rand ; $(MAKE) -f $(GALAHAD)/makefiles/$(VERSION) \
            rand.o PRECIS=$(PRECIS) PWD=$(PWD)/../rand )
copyright:
	( cd ../copyright ; $(MAKE) -f $(GALAHAD)/makefiles/$(VERSION) \
            copyright.o PRECIS=$(PRECIS) PWD=$(PWD)/../copyright )
ma57:
	( cd ../external/ma57 ; $(MAKE) -f $(GALAHAD)/makefiles/$(VERSION) \
            ma57_silent PRECIS=$(PRECIS) PWD=$(PWD)/../external/ma57 )
ma61:
	( cd ../external/ma61 ; $(MAKE) -f $(GALAHAD)/makefiles/$(VERSION) \
            ma61_silent PRECIS=$(PRECIS) PWD=$(PWD)/../external/ma61 )
ad02:
	( cd ../external/ad02 ; $(MAKE) -f $(GALAHAD)/makefiles/$(VERSION) \
            ad02_silent PRECIS=$(PRECIS) PWD=$(PWD)/../external/ad02 )
icfs:
	( cd ../icfs ; $(MAKE) -f $(GALAHAD)/makefiles/$(VERSION) \
            icfs_silent PRECIS=$(PRECIS) PWD=$(PWD)/../icfs )

#  constituent packages

bndsl.o: $(LG)(bndsl_$(PRECIS).o)

$(LG)(bndsl_$(PRECIS).o): ../lancelot/bndsl.F90
	@printf ' %-9s %-15s\t\t' "Compiling" "bndsl"
	$(CP) ../lancelot/bndsl.F90 $(OBJ)/bndsl.F90
	cd $(OBJ); $(FORTRAN) -o bndsl_$(PRECIS).o $(FFLAGSS) bndsl.F90 \
                || ( printf ' %-26s' "=> Disabling optimization " ; \
                   $(FORTRAN) -o bndsl_$(PRECIS).o $(FFLAGSN) bndsl.F90 )
	cd $(OBJ); $(ARR) bndsl_$(PRECIS).o; $(RM) bndsl.F90 bndsl_$(PRECIS).o
	$(RMARFILE) precn_$(PRECIS).o
	$(RMARFILE) psls_$(PRECIS).o
	$(MVMODS)
	@printf '[ OK ]\n'

others.o: $(LG)(others_$(PRECIS).o)

$(LG)(others_$(PRECIS).o): ../lancelot/others.F90
	@printf ' %-9s %-15s\t\t' "Compiling" "others"
	$(CP) ../lancelot/others.F90 $(OBJ)/others.F90
	cd $(OBJ); $(FORTRAN) -o others_$(PRECIS).o $(FFLAGSS) others.F90 \
                || ( printf ' %-26s' "=> Disabling optimization " ; \
                   $(FORTRAN) -o others_$(PRECIS).o $(FFLAGSN) others.F90 )
	cd $(OBJ); $(ARR) others_$(PRECIS).o; \
          $(RM) others.F90 others_$(PRECIS).o
	$(RMARFILE) initw.o
	$(MVMODS)
	@printf '[ OK ]\n'

strutr.o: $(LG)(strutr_$(PRECIS).o)

$(LG)(strutr_$(PRECIS).o): ../lancelot/strutr.F90
	@printf ' %-9s %-15s\t\t' "Compiling" "strutr"
	$(CP) ../lancelot/strutr.F90  $(OBJ)/strutr.F90
	cd $(OBJ); $(FORTRAN) -o strutr_$(PRECIS).o $(FFLAGSS) strutr.F90 \
                || ( printf ' %-26s' "=> Disabling optimization " ; \
                   $(FORTRAN) -o strutr_$(PRECIS).o $(FFLAGSN) strutr.F90 )
	cd $(OBJ); $(ARR) strutr_$(PRECIS).o; \
          $(RM) strutr.F90 strutr_$(PRECIS).o
	$(RMARFILE) lancelot_$(PRECIS).o
	$(MVMODS)
	@printf '[ OK ]\n'

cauchy.o: $(LG)(cauchy_$(PRECIS).o)

$(LG)(cauchy_$(PRECIS).o): ../lancelot/cauchy.F90
	@printf ' %-9s %-15s\t\t' "Compiling" "cauchy "
	$(CP) ../lancelot/cauchy.F90 $(OBJ)/cauchy.F90
	cd $(OBJ); $(FORTRAN) -o cauchy_$(PRECIS).o $(FFLAGSS) cauchy.F90 \
                || ( printf ' %-26s' "=> Disabling optimization " ; \
                   $(FORTRAN) -o cauchy_$(PRECIS).o $(FFLAGSN) cauchy.F90 )
	cd $(OBJ); $(ARR) cauchy_$(PRECIS).o; \
          $(RM) cauchy.F90 cauchy_$(PRECIS).o
	$(RMARFILE) lancelot_$(PRECIS).o
	$(MVMODS)
	@printf '[ OK ]\n'

cg.o: $(LG)(cg_$(PRECIS).o)

$(LG)(cg_$(PRECIS).o): ../lancelot/cg.F90
	@printf ' %-9s %-15s\t\t' "Compiling" "cg    "
	$(CP) ../lancelot/cg.F90 $(OBJ)/cg.F90
	cd $(OBJ); $(FORTRAN) -o cg_$(PRECIS).o $(FFLAGSS) cg.F90 \
                || ( printf ' %-26s' "=> Disabling optimization " ; \
                   $(FORTRAN) -o cg_$(PRECIS).o $(FFLAGSN) cg.F90 )
	cd $(OBJ); $(ARR) cg_$(PRECIS).o; $(RM) cg.F90 cg_$(PRECIS).o
	$(RMARFILE) lancelot_$(PRECIS).o
	$(MVMODS)
	@printf '[ OK ]\n'

hslint.o: $(LG)(hslint_$(PRECIS).o)

$(LG)(hslint_$(PRECIS).o): ../lancelot/hslint.F90
	@printf ' %-9s %-15s\t\t' "Compiling" "hslint"
	$(CP) ../lancelot/hslint.F90 $(OBJ)/hslint.F90
	cd $(OBJ); $(FORTRAN) -o hslint_$(PRECIS).o $(FFLAGSS) hslint.F90 \
                || ( printf ' %-26s' "=> Disabling optimization " ; \
                   $(FORTRAN) -o hslint_$(PRECIS).o $(FFLAGSN) hslint.F90 )
	cd $(OBJ); $(ARR) hslint_$(PRECIS).o; \
          $(RM) hslint.F90 hslint_$(PRECIS).o
	$(RMARFILE) mdchl_$(PRECIS).o
	$(MVMODS)
	@printf '[ OK ]\n'

asmbl.o: $(LG)(asmbl_$(PRECIS).o)

$(LG)(asmbl_$(PRECIS).o): ../lancelot/asmbl.F90
	@printf ' %-9s %-15s\t\t' "Compiling" "asmbl "
	$(CP) ../lancelot/asmbl.F90 $(OBJ)/asmbl.F90
	cd $(OBJ); $(FORTRAN) -o asmbl_$(PRECIS).o $(FFLAGSS) asmbl.F90 \
                || ( printf ' %-26s' "=> Disabling optimization " ; \
                   $(FORTRAN) -o asmbl_$(PRECIS).o $(FFLAGSN) asmbl.F90 )
	cd $(OBJ); $(ARR) asmbl_$(PRECIS).o; $(RM) asmbl.F90 asmbl_$(PRECIS).o
	$(RMARFILE) precn_$(PRECIS).o
	$(RMARFILE) frntl_$(PRECIS).o
	$(MVMODS)
	@printf '[ OK ]\n'

drchg.o: $(LG)(drchg_$(PRECIS).o)

$(LG)(drchg_$(PRECIS).o): ../lancelot/drchg.F90
	@printf ' %-9s %-15s\t\t' "Compiling" "drchg "
	$(CP) ../lancelot/drchg.F90 $(OBJ)/drchg.F90
	cd $(OBJ); $(FORTRAN) -o drchg_$(PRECIS).o $(FFLAGSS) drchg.F90 \
                || ( printf ' %-26s' "=> Disabling optimization " ; \
                   $(FORTRAN) -o drchg_$(PRECIS).o $(FFLAGSN) drchg.F90 )
	cd $(OBJ); $(ARR) drchg_$(PRECIS).o; $(RM) drchg.F90 drchg_$(PRECIS).o
	$(CURMARFILE) uselancelot_$(PRECIS).o
	$(CURMARFILE) uselancelot_steering_$(PRECIS).o
	$(MVMODS)
	@printf '[ OK ]\n'

drche.o: $(LG)(drche_$(PRECIS).o)

$(LG)(drche_$(PRECIS).o): ../lancelot/drche.F90
	@printf ' %-9s %-15s\t\t' "Compiling" "drche "
	$(CP) ../lancelot/drche.F90 $(OBJ)/drche.F90
	cd $(OBJ); $(FORTRAN) -o drche_$(PRECIS).o $(FFLAGSS) drche.F90 \
                || ( printf ' %-26s' "=> Disabling optimization " ; \
                   $(FORTRAN) -o drche_$(PRECIS).o $(FFLAGSN) drche.F90 )
	cd $(OBJ); $(ARR) drche_$(PRECIS).o; $(RM) drche.F90 drche_$(PRECIS).o
	$(CURMARFILE) uselancelot_$(PRECIS).o
	$(CURMARFILE) uselancelot_steering_$(PRECIS).o
	$(MVMODS)
	@printf '[ OK ]\n'

hsprd.o: $(LG)(hsprd_$(PRECIS).o)

$(LG)(hsprd_$(PRECIS).o): ../lancelot/hsprd.F90
	@printf ' %-9s %-15s\t\t' "Compiling" "hsprd "
	$(CP) ../lancelot/hsprd.F90 $(OBJ)/hsprd.F90
	cd $(OBJ); $(FORTRAN) -o hsprd_$(PRECIS).o $(FFLAGSS) hsprd.F90 \
                || ( printf ' %-26s' "=> Disabling optimization " ; \
                   $(FORTRAN) -o hsprd_$(PRECIS).o $(FFLAGSN) hsprd.F90 \ )
	cd $(OBJ); $(ARR) hsprd_$(PRECIS).o; $(RM) hsprd.F90 hsprd_$(PRECIS).o
	$(RMARFILE) lancelot_$(PRECIS).o
	@printf '[ OK ]\n'
	$(MVMODS)

initw.o: $(LG)(initw_$(PRECIS).o)

$(LG)(initw_$(PRECIS).o): ../lancelot/initw.F90
	@printf ' %-9s %-15s\t\t' "Compiling" "initw "
	$(CP) ../lancelot/initw.F90 $(OBJ)/initw.F90
	cd $(OBJ); $(FORTRAN) -o initw_$(PRECIS).o $(FFLAGSS) initw.F90 \
                || ( printf ' %-26s' "=> Disabling optimization " ; \
                   $(FORTRAN) -o initw_$(PRECIS).o $(FFLAGSN) initw.F90 )
	cd $(OBJ); $(ARR) initw_$(PRECIS).o; $(RM) initw.F90 initw_$(PRECIS).o
	$(RMARFILE) lancelot_$(PRECIS).o
	$(MVMODS)
	@printf '[ OK ]\n'

scaln.o: $(LG)(scaln_$(PRECIS).o)

$(LG)(scaln_$(PRECIS).o): ../lancelot/scaln.F90
	@printf ' %-9s %-15s\t\t' "Compiling" "scaln "
	$(CP) ../lancelot/scaln.F90 $(OBJ)/scaln.F90
	cd $(OBJ); $(FORTRAN) -o scaln_$(PRECIS).o $(FFLAGSS) scaln.F90 \
                || ( printf ' %-26s' "=> Disabling optimization " ; \
                   $(FORTRAN) -o scaln_$(PRECIS).o $(FFLAGSN) scaln.F90 )
	cd $(OBJ); $(ARR) scaln_$(PRECIS).o; $(RM) scaln.F90 scaln_$(PRECIS).o
	$(CURMARFILE) uselancelot_$(PRECIS).o
	$(CURMARFILE) uselancelot_steering_$(PRECIS).o
	$(MVMODS)
	@printf '[ OK ]\n'

mdchl.o: $(LG)(mdchl_$(PRECIS).o)

$(LG)(mdchl_$(PRECIS).o): ../lancelot/mdchl.F90
	@printf ' %-9s %-15s\t\t' "Compiling" "mdchl "
	$(CP) ../lancelot/mdchl.F90 $(OBJ)/mdchl.F90
	cd $(OBJ); $(FORTRAN) -o mdchl_$(PRECIS).o $(FFLAGSS) mdchl.F90 \
                || ( printf ' %-26s' "=> Disabling optimization " ; \
                   $(FORTRAN) -o mdchl_$(PRECIS).o $(FFLAGSN) mdchl.F90 )
	cd $(OBJ); $(ARR) mdchl_$(PRECIS).o; $(RM) mdchl.F90 mdchl_$(PRECIS).o
	$(RMARFILE) precn_$(PRECIS).o
	$(RMARFILE) frntl_$(PRECIS).o
	$(RMARFILE) psls_$(PRECIS).o
	$(MVMODS)
	@printf '[ OK ]\n'

precn.o: $(LG)(precn_$(PRECIS).o)

$(LG)(precn_$(PRECIS).o): ../lancelot/precn.F90
	@printf ' %-9s %-15s\t\t' "Compiling" "precn "
	$(CP) ../lancelot/precn.F90 $(OBJ)/precn.F90
	cd $(OBJ); $(FORTRAN) -o precn_$(PRECIS).o $(FFLAGSS) precn.F90 \
                || ( printf ' %-26s' "=> Disabling optimization " ; \
                   $(FORTRAN) -o precn_$(PRECIS).o $(FFLAGSN) precn.F90 )
	cd $(OBJ); $(ARR) precn_$(PRECIS).o; $(RM) precn.F90 precn_$(PRECIS).o
	$(RMARFILE) lancelot_$(PRECIS).o
	$(MVMODS)
	@printf '[ OK ]\n'

frntl.o: $(LG)(frntl_$(PRECIS).o)

$(LG)(frntl_$(PRECIS).o): ../lancelot/frntl.F90
	@printf ' %-9s %-15s\t\t' "Compiling" "frntl "
	$(CP) ../lancelot/frntl.F90 $(OBJ)/frntl.F90
	cd $(OBJ); $(FORTRAN) -o frntl_$(PRECIS).o $(FFLAGSS) frntl.F90 \
                || ( printf ' %-26s' "=> Disabling optimization " ; \
                   $(FORTRAN) -o frntl_$(PRECIS).o $(FFLAGSN) frntl.F90 )
	cd $(OBJ); $(ARR) frntl_$(PRECIS).o; $(RM) frntl.F90 frntl_$(PRECIS).o
	$(RMARFILE) lancelot_$(PRECIS).o
	$(MVMODS)
	@printf '[ OK ]\n'

lancelot_types.o: $(LG)(lancelot_types_$(PRECIS).o)

$(LG)(lancelot_types_$(PRECIS).o): ../lancelot/lancelot_types.F90
	@printf ' %-9s %-15s\t\t' "Compiling" "lancelot_types"
	$(CP) ../lancelot/lancelot_types.F90 $(OBJ)/lancelot_types.F90
	cd $(OBJ); $(FORTRAN) -o lancelot_types_$(PRECIS).o $(FFLAGSS) \
                     lancelot_types.F90 \
                || ( printf ' %-26s' "=> Disabling optimization " ; \
                   $(FORTRAN) -o lancelot_types_$(PRECIS).o $(FFLAGSN) \
                     lancelot_types.F90 )
	cd $(OBJ); $(ARR) lancelot_types_$(PRECIS).o; \
                     $(RM) lancelot_types.F90 lancelot_types_$(PRECIS).o
	$(RMARFILE) lancelot_$(PRECIS).o
	$(RMARFILE) lancelot_steering_$(PRECIS).o
	$(RMARFILE) drche_$(PRECIS).o
	$(RMARFILE) drchg_$(PRECIS).o
	$(RMARFILE) scaln_$(PRECIS).o
	$(MVMODS)
	@printf '[ OK ]\n'

lancelot.o: $(LG)(lancelot_$(PRECIS).o)

$(LG)(lancelot_$(PRECIS).o): ../lancelot/lancelot.F90
	@printf ' %-9s %-15s\t\t' "Compiling" "lancelot"
	$(CP) ../lancelot/lancelot.F90 $(OBJ)/lancelot.F90
	cd $(OBJ); $(FORTRAN) -o lancelot_$(PRECIS).o $(FFLAGSS) lancelot.F90 \
                || ( printf ' %-26s' "=> Disabling optimization " ; \
                   $(FORTRAN) -o lancelot_$(PRECIS).o $(FFLAGSN) lancelot.F90 )
	cd $(OBJ); $(ARR) lancelot_$(PRECIS).o; \
           $(RM) lancelot.F90 lancelot_$(PRECIS).o
	$(RMARFILE) lancelot_simple_$(PRECIS).o
	$(RMARFILE) drche_$(PRECIS).o
	$(RMARFILE) drchg_$(PRECIS).o
	$(RMARFILE) scaln_$(PRECIS).o
	$(RMOBFILE) lancelots.o
	$(RMOBFILE) lancelott_$(PRECIS).o
	$(RMOBFILE) galahad_ampl.o
	$(MVMODS)
	@printf '[ OK ]\n'

lancelot_steering.o: $(LG)(lancelot_steering_$(PRECIS).o)

$(LG)(lancelot_steering_$(PRECIS).o): ../lancelot/lancelot_steering.F90
	@printf ' %-9s %-15s\t\t' "Compiling" "lancelot_steering"
	$(CP) ../lancelot/lancelot_steering.F90 \
          $(OBJ)/lancelot_steering.F90
	cd $(OBJ); $(FORTRAN) -o lancelot_steering_$(PRECIS).o $(FFLAGSS) \
          lancelot_steering.F90 \
                || ( printf ' %-26s' "=> Disabling optimization " ; \
                   $(FORTRAN) -o lancelot_steering_$(PRECIS).o $(FFLAGSN) \
                     lancelot_steering.F90 )
	cd $(OBJ); $(ARR) lancelot_steering_$(PRECIS).o ; \
                     $(RM) lancelot_steering.F90 lancelot_steering_$(PRECIS).o
	$(RMARFILE) drche_$(PRECIS).o
	$(RMARFILE) drchg_$(PRECIS).o
	$(RMARFILE) scaln_$(PRECIS).o
	$(RMOBFILE) lancelot_steerings.o
	$(RMOBFILE) lancelot_steeringt_$(PRECIS).o
	$(RMOBFILE) galahad_ampl.o
	$(MVMODS)
	@printf '[ OK ]\n'

lancelot_simple.o: $(LG)(lancelot_simple_$(PRECIS).o)

$(LG)(lancelot_simple_$(PRECIS).o): ../lancelot_simple/lancelot_simple.F90
	@printf ' %-9s %-15s\t\t' "Compiling" "lancelot_simple"
	$(CP) ../lancelot_simple/lancelot_simple.F90 \
           $(OBJ)/lancelot_simple.F90
	cd $(OBJ); $(FORTRAN) -o lancelot_simple_$(PRECIS).o $(FFLAGSS) \
                   lancelot_simple.F90 \
                || ( printf ' %-26s' "=> Disabling optimization " ; \
                   $(FORTRAN) -o lancelot_simple_$(PRECIS).o $(FFLAGSN) \
                   lancelot_simple.F90 )
	cd $(OBJ); $(ARR) lancelot_simple_$(PRECIS).o; \
             $(RM) lancelot_simple.F90 lancelot_simple_$(PRECIS).o
	$(RMOBFILE) lancelot_simples.o
	$(RMOBFILE) lancelot_simplet_$(PRECIS).o
	$(MVMODS)
	@printf '[ OK ]\n'

#  SIF interfaces

uselancelot.o: $(CULG)(uselancelot_$(PRECIS).o)

$(CULG)(uselancelot_$(PRECIS).o): ../lancelot/uselancelot.F90
	@printf ' %-9s %-15s\t\t' "Compiling" "uselancelot "
	$(CP) ../lancelot/uselancelot.F90 $(OBJ)/uselancelot.F90
	cd $(OBJ); $(FORTRAN) -o uselancelot_$(PRECIS).o \
                     $(FFLAGSS) uselancelot.F90 \
                || ( printf ' %-26s' "=> Disabling optimization " ; \
                   $(FORTRAN) -o uselancelot_$(PRECIS).o \
                     $(FFLAGSN) uselancelot.F90 )
	cd $(OBJ); $(CUARR) uselancelot_$(PRECIS).o ; \
          $(RM) uselancelot.F90 uselancelot_$(PRECIS).o
	$(RMOBFILE) runlancelot_sif_$(PRECIS)_$(PRECIS).o
	$(MVMODS)
	@printf '[ OK ]\n'

uselancelot_steering.o: $(CULG)(uselancelot_steering_$(PRECIS).o)

$(CULG)(uselancelot_steering_$(PRECIS).o): ../lancelot/uselancelot_steering.F90
	@printf ' %-9s %-15s\t\t' "Compiling" "uselancelot_steering "
	$(CP) ../lancelot/uselancelot_steering.F90 \
          $(OBJ)/uselancelot_steering.F90
	cd $(OBJ); $(FORTRAN) -o uselancelot_steering_$(PRECIS).o $(FFLAGSS) \
          uselancelot_steering.F90 \
                || ( printf ' %-26s' "=> Disabling optimization " ; \
                   $(FORTRAN) -o uselancelot_steering_$(PRECIS).o $(FFLAGSN) \
                     uselancelot_steering.F90 )
	cd $(OBJ); $(CUARR) uselancelot_steering_$(PRECIS).o ; \
          $(RM) uselancelot_steering.F90 uselancelot_steering_$(PRECIS).o
	$(RMOBFILE) runlancelot_steering_sif_$(PRECIS).o
	$(MVMODS)
	@printf '[ OK ]\n'

#  main program

runlancelot_sif.o: $(OBJ)/runlancelot_sif_$(PRECIS).o

$(OBJ)/runlancelot_sif_$(PRECIS).o: ../lancelot/runlancelot_sif.F90
	@printf ' %-9s %-15s\t\t' "Compiling" "runlancelot_sif"
	$(CP) ../lancelot/runlancelot_sif.F90 \
          $(OBJ)/runlancelot_sif.F90
	cd $(OBJ); $(FORTRAN) -o runlancelot_sif_$(PRECIS).o $(FFLAGSS) \
           runlancelot_sif.F90
	$(RM) $(OBJ)/runlancelot_sif.F90
	@printf '[ OK ]\n'

runlancelot_steering_sif.o: $(OBJ)/runlancelot_steering_sif_$(PRECIS).o

$(OBJ)/runlancelot_steering_sif_$(PRECIS).o: ../lancelot/runlancelot_steering_sif.F90
	@printf ' %-9s %-15s\t\t' "Compiling" "runlancelot_steering_sif"
	$(CP) ../lancelot/runlancelot_steering_sif.F90 \
          $(OBJ)/runlancelot_steering_sif.F90
	cd $(OBJ); $(FORTRAN) -o runlancelot_steering_sif_$(PRECIS).o \
          $(FFLAGSS) runlancelot_steering_sif.F90
	$(RM) $(OBJ)/runlancelot_steering_sif.F90
	@printf '[ OK ]\n'

#  main program for spec example

lancelots.o: $(OBJ)/lancelots_$(PRECIS).o

$(OBJ)/lancelots_$(PRECIS).o: ../lancelot/lancelots.f90
	@printf ' %-9s %-15s\t\t' "Compiling" "lancelots"
	$(SED) -f $(SEDS) ../lancelot/lancelots.f90 > $(OBJ)/lancelots.f90
	cd $(OBJ); $(FORTRAN) -o lancelots_$(PRECIS).o $(FFLAGSS) lancelots.f90
	$(RM) $(OBJ)/lancelots.f90
	@printf '[ OK ]\n'

lancelot_steerings.o: $(OBJ)/lancelot_steerings_$(PRECIS).o

$(OBJ)/lancelot_steerings_$(PRECIS).o: ../lancelot/lancelot_steerings.f90
	@printf ' %-9s %-15s\t\t' "Compiling" "lancelot_steerings"
	$(SED) -f $(SEDS) ../lancelot/lancelot_steerings.f90 > \
          $(OBJ)/lancelot_steerings.f90
	cd $(OBJ); $(FORTRAN) -o lancelot_steerings_$(PRECIS).o $(FFLAGSS) \
           lancelot_steerings.f90
	$(RM) $(OBJ)/lancelot_steerings.f90
	@printf '[ OK ]\n'

lancelot_simples.o: $(OBJ)/lancelot_simples_$(PRECIS).o

$(OBJ)/lancelot_simples_$(PRECIS).o: ../lancelot_simple/lancelot_simples.f90
	@printf ' %-9s %-15s\t\t' "Compiling" "lancelot_simples"
	$(SED) -f $(SEDS) \
          ../lancelot_simple/lancelot_simples.f90 > $(OBJ)/lancelot_simples.f90
	cd $(OBJ); $(FORTRAN) -o lancelot_simples_$(PRECIS).o $(FFLAGSS) \
           lancelot_simples.f90
	$(RM) $(OBJ)/lancelot_simples.f90
	@printf '[ OK ]\n'

#  main program for exhaustive test deck

lancelott.o: $(OBJ)/lancelott_$(PRECIS).o

$(OBJ)/lancelott_$(PRECIS).o: ../lancelot/lancelott.F90
	@printf ' %-9s %-15s\t\t' "Compiling" "lancelott"
	$(CP) lancelott.F90 $(OBJ)/lancelott.F90
	cd $(OBJ); $(FORTRAN) -o lancelott_$(PRECIS).o $(FFLAGSS) lancelott.F90
	$(RM) $(OBJ)/lancelott.F90
	@printf '[ OK ]\n'

lancelot_steeringt.o: $(OBJ)/lancelot_steeringt_$(PRECIS).o

$(OBJ)/lancelot_steeringt_$(PRECIS).o: ../lancelot/lancelot_steeringt.F90
	@printf ' %-9s %-15s\t\t' "Compiling" "lancelot_steeringt"
	$(CP) lancelot_steeringt.F90 $(OBJ)/lancelot_steeringt.F90
	cd $(OBJ); $(FORTRAN) -o lancelot_steeringt_$(PRECIS).o $(FFLAGSS) \
              lancelot_steeringt.F90
	$(RM) $(OBJ)/lancelot_steeringt.F90
	@printf '[ OK ]\n'

lancelot_simplet.o: $(OBJ)/lancelot_simplet_$(PRECIS).o

$(OBJ)/lancelot_simplet_$(PRECIS).o: ../lancelot_simple/lancelot_simplet.F90
	@printf ' %-9s %-15s\t\t' "Compiling" "lancelot_simplet"
	$(CP) ../lancelot_simple/lancelot_simplet.F90 \
          $(OBJ)/lancelot_simplet.F90
	cd $(OBJ); $(FORTRAN) -o lancelot_simplet_$(PRECIS).o $(FFLAGSS) \
           lancelot_simplet.F90
	$(RM) $(OBJ)/lancelot_simplet.F90
	@printf '[ OK ]\n'

#  book keeping

clean:
	@printf ' %-9s\t\t' "Cleaning"
	$(RM) $(LGS) $(LGD) $(OBJS)/runlancelot_sif_$(PRECIS).o \
                            $(OBJD)/runlancelot_sif_$(PRECIS).o
	@printf '[ OK ]\n'

cleanall:
	@printf ' %-14s\t\t' "Removing all $(PRECIS) precision object and module files"
	$(RM) -r $(OBJ)/* $(MOD)/*
	@printf '[ OK ]\n'
